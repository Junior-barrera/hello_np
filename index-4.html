<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baches Arica - B√∫squeda Corregida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 80px); /* Altura total menos el header */
        }
        
        .map-section {
            width: 80%;
            height: 100%;
            position: sticky;
            top: 0;
        }
        
        #map { 
            height: 100%;
            width: 100%;
        }
        
        .panel-section {
            width: 20%;
            height: 100%;
            overflow-y: auto;
            background: #f9fafb;
        }
        
        .leaflet-popup-content { min-width: 250px; }
        .leaflet-container { font-family: inherit; }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #eff6ff;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-loading {
            padding: 1rem;
            text-align: center;
            color: #6b7280;
        }
        
        /* Scrollbar personalizado para el panel */
        .panel-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .panel-section::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .panel-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .panel-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-road"></i> Baches Arica
                <span class="text-sm bg-green-500 px-2 py-1 rounded-full font-normal">
                    <i class="fas fa-cloud"></i> Google Sheets
                </span>
            </h1>
            <p class="text-blue-100 mt-1">Sistema conectado con Google Sheets en tiempo real</p>
        </div>
    </header>

    <div class="main-container">
        <!-- MAPA 80% - STICKY -->
        <div class="map-section">
            <div class="relative h-full">
                <!-- Buscador de calles - CENTRADO Y SEMI-TRANSPARENTE -->
                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] w-[500px] max-w-[90%]">
                    <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200">
                        <div class="flex items-center p-3 gap-2">
                            <i class="fas fa-search text-blue-600 text-lg"></i>
                            <input 
                                type="text" 
                                id="streetSearch" 
                                class="flex-1 outline-none text-gray-800 bg-transparent placeholder-gray-500 font-medium" 
                                placeholder="Buscar calle en Arica... (Ej: Baquedano con 21 de Mayo)"
                            >
                            <button id="clearSearch" class="text-gray-400 hover:text-gray-700 hidden transition">
                                <i class="fas fa-times-circle text-lg"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="search-results hidden"></div>
                    </div>
                </div>
                
                <div id="map"></div>
                
                <!-- Controles de mapa con men√∫ desplegable -->
                <div class="absolute top-4 right-4 z-[1000]">
                    <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200">
                        <div class="flex flex-col gap-2 p-2">
                            <!-- Bot√≥n Mapa con dropdown -->
                            <div class="relative">
                                <button id="mapMenuBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2.5 rounded-lg hover:from-blue-700 hover:to-blue-800 transition flex items-center justify-between gap-2 shadow-md">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-layer-group"></i>
                                        <span class="font-medium">Mapa</span>
                                    </div>
                                    <i class="fas fa-chevron-down text-sm"></i>
                                </button>
                                
                                <!-- Men√∫ desplegable de capas -->
                                <div id="mapLayersMenu" class="hidden absolute top-full right-0 mt-2 w-56 bg-white rounded-lg shadow-2xl border border-gray-200 overflow-hidden">
                                    <div class="p-2 space-y-1">
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-blue-50 transition flex items-center gap-3" data-layer="streets">
                                            <i class="fas fa-road text-blue-600 w-5"></i>
                                            <span class="font-medium text-gray-700">Calles (Normal)</span>
                                        </button>
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-gray-700 hover:text-white transition flex items-center gap-3" data-layer="dark">
                                            <i class="fas fa-moon text-gray-700 w-5"></i>
                                            <span class="font-medium text-gray-700">Oscuro</span>
                                        </button>
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-green-50 transition flex items-center gap-3" data-layer="satellite">
                                            <i class="fas fa-satellite text-green-600 w-5"></i>
                                            <span class="font-medium text-gray-700">Satelital</span>
                                        </button>
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-orange-50 transition flex items-center gap-3" data-layer="terrain">
                                            <i class="fas fa-mountain text-orange-600 w-5"></i>
                                            <span class="font-medium text-gray-700">Topogr√°fico</span>
                                        </button>
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-red-50 transition flex items-center gap-3" data-layer="heat">
                                            <i class="fas fa-fire text-red-600 w-5"></i>
                                            <span class="font-medium text-gray-700">Mapa de Calor</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Zoom m√°ximo -->
                            <button id="zoomInMax" class="bg-purple-600 text-white px-4 py-2.5 rounded-lg hover:bg-purple-700 transition shadow-md" title="Zoom m√°ximo (nivel 20)">
                                <i class="fas fa-search-plus mr-2"></i>Zoom 19x
                            </button>
                            
                            <!-- Reset vista -->
                            <button id="resetZoom" class="bg-gray-600 text-white px-4 py-2.5 rounded-lg hover:bg-gray-700 transition shadow-md" title="Volver a vista de Arica">
                                <i class="fas fa-globe-americas mr-2"></i>Reset
                            </button>
                            
                            <!-- Indicador de zoom -->
                            <div class="text-center text-xs text-gray-700 font-semibold bg-gray-100 py-2 px-3 rounded-lg">
                                Zoom: <span id="currentZoom" class="text-blue-600">12</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Leyenda -->
                <div class="absolute bottom-4 left-4 z-[1000] bg-white bg-opacity-95 backdrop-blur-sm p-3 rounded-lg shadow-xl border border-gray-200">
                    <div class="flex flex-wrap gap-3">
                        <div class="flex items-center gap-1">
                            <div class="w-5 h-5 bg-red-500 rounded-full border-2 border-white shadow"></div>
                            <span class="text-sm font-medium text-gray-800">Alta</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-5 h-5 bg-yellow-500 rounded-full border-2 border-white shadow"></div>
                            <span class="text-sm font-medium text-gray-800">Media</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-5 h-5 bg-green-500 rounded-full border-2 border-white shadow"></div>
                            <span class="text-sm font-medium text-gray-800">Baja</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-5 h-5 bg-blue-500 rounded-full border-2 border-white shadow"></div>
                            <span class="text-sm font-medium text-gray-800">B√∫squeda</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL 20% - SCROLLABLE -->
        <div class="panel-section">
            <div class="p-4">
                <!-- Panel de reportar -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-4">
                    <div class="flex items-center justify-between mb-3 border-b pb-2">
                        <h2 class="text-lg font-bold text-blue-900">
                            <i class="fas fa-plus-circle mr-2"></i>Reportar Bache
                        </h2>
                        <button id="refreshBtn" class="text-blue-600 hover:text-blue-800 transition" title="Actualizar datos">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Gravedad</label>
                            <select id="severity" class="w-full p-2 border border-gray-300 rounded text-sm">
                                <option value="low">Baja</option>
                                <option value="medium" selected>Media</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Descripci√≥n</label>
                            <textarea id="description" rows="3" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Describe el bache..."></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="lat" class="w-full p-1.5 border border-gray-300 rounded text-xs" placeholder="Lat" readonly>
                                <input type="text" id="lng" class="w-full p-1.5 border border-gray-300 rounded text-xs" placeholder="Lng" readonly>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-mouse-pointer mr-1"></i> Click en el mapa
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button id="reportBtn" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded transition text-sm font-medium">
                                <i class="fas fa-paper-plane mr-1"></i>Reportar
                            </button>
                            <button id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition text-sm">
                                <i class="fas fa-eraser mr-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtros de estado -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">
                        <i class="fas fa-filter mr-2"></i>Filtrar por Estado
                    </h3>
                    <div class="flex flex-col gap-2">
                        <button id="filterAll" class="filter-btn bg-blue-500 text-white p-2 rounded text-xs font-medium hover:bg-blue-600 transition">
                            <i class="fas fa-list mr-1"></i> Todos (<span id="countAll">0</span>)
                        </button>
                        <button id="filterPending" class="filter-btn bg-gray-200 text-gray-700 p-2 rounded text-xs font-medium hover:bg-gray-300 transition">
                            <i class="fas fa-clock mr-1"></i> Pendientes (<span id="countPending">0</span>)
                        </button>
                        <button id="filterRepaired" class="filter-btn bg-gray-200 text-gray-700 p-2 rounded text-xs font-medium hover:bg-gray-300 transition">
                            <i class="fas fa-check-circle mr-1"></i> Reparados (<span id="countRepaired">0</span>)
                        </button>
                    </div>
                </div>

                <!-- Zonas r√°pidas -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">
                        <i class="fas fa-map-marked-alt mr-2"></i>Zonas de Arica
                    </h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="zone-btn bg-blue-100 hover:bg-blue-200 text-blue-800 p-2 rounded text-xs" data-lat="-18.4783" data-lng="-70.3126" data-zoom="16">
                            Centro
                        </button>
                        <button class="zone-btn bg-blue-100 hover:bg-blue-200 text-blue-800 p-2 rounded text-xs" data-lat="-18.4833" data-lng="-70.3189" data-zoom="16">
                            El Morro
                        </button>
                        <button class="zone-btn bg-blue-100 hover:bg-blue-200 text-blue-800 p-2 rounded text-xs" data-lat="-18.4950" data-lng="-70.3000" data-zoom="16">
                            San Jos√©
                        </button>
                        <button class="zone-btn bg-blue-100 hover:bg-blue-200 text-blue-800 p-2 rounded text-xs" data-lat="-18.4600" data-lng="-70.3200" data-zoom="16">
                            Chinchorro
                        </button>
                    </div>
                </div>

                <!-- Filtro por A√±o -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">
                        <i class="fas fa-calendar-alt mr-2"></i>Filtrar por A√±o
                    </h3>
                    <div id="yearFilters" class="flex flex-col gap-2">
                        <!-- Los a√±os se generar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>

                <!-- Filtro por Mes -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">
                        <i class="fas fa-calendar-day mr-2"></i>Filtrar por Mes
                    </h3>
                    <div id="monthFilters" class="grid grid-cols-3 gap-1">
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="all">
                            Todos
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="1">
                            Ene
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="2">
                            Feb
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="3">
                            Mar
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="4">
                            Abr
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="5">
                            May
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="6">
                            Jun
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="7">
                            Jul
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="8">
                            Ago
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="9">
                            Sep
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="10">
                            Oct
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="11">
                            Nov
                        </button>
                        <button class="month-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-2 py-1.5 rounded text-xs font-medium transition" data-month="12">
                            Dic
                        </button>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">
                        <i class="fas fa-chart-bar mr-2"></i>Estad√≠sticas
                    </h3>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-blue-50 p-2 rounded text-center border border-blue-100">
                            <div class="text-xl font-bold text-blue-700" id="totalCount">0</div>
                            <div class="text-xs text-gray-600">Total</div>
                        </div>
                        <div class="bg-red-50 p-2 rounded text-center border border-red-100">
                            <div class="text-xl font-bold text-red-700" id="highCount">0</div>
                            <div class="text-xs text-gray-600">Graves</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded text-center border border-green-100">
                            <div class="text-xl font-bold text-green-700" id="recentCount">0</div>
                            <div class="text-xs text-gray-600">24h</div>
                        </div>
                    </div>
                </div>

                <!-- Lista de baches -->
                <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200">
                    <h2 class="text-lg font-bold text-blue-900 mb-3 border-b pb-2">
                        <i class="fas fa-list mr-2"></i>Baches Reportados
                    </h2>
                    <div id="potholeList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalles -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[2000]">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-blue-900 to-blue-700 text-white p-4 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">
                        <i class="fas fa-info-circle mr-2"></i>Detalles del Bache
                    </h3>
                    <button id="closeModal" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div id="modalContent" class="p-6"></div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // ============================================
            // CONFIGURACI√ìN DE GOOGLE SHEETS API
            // ============================================
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwEkdupG22rPv4R2Fnc25DWX6WmKSSdP6Pa4LQ6pL90eFY9NEVTCW3JJxwbUbOQ427t/exec';
            
            // Variables globales
            let map, marker, selectedLocation;
            let potholes = [];
            let searchMarker = null;
            let searchTimeout = null;
            let isLoadingData = false;
            let currentFilter = 'all'; // all, pending, repaired
            let currentYearFilter = 'all'; // Variable para el filtro de a√±o
            let currentMonthFilter = 'all'; // Variable para el filtro de mes
            
            const severityColors = {
                high: '#ef4444',
                medium: '#eab308',
                low: '#22c55e'
            };
            
            // L√≠mites de Arica (corregidos)
            const ARICA_BOUNDS = L.latLngBounds(
                L.latLng(-18.55, -70.35), // Suroeste
                L.latLng(-18.40, -70.25)  // Noreste
            );
            
            // Inicializar mapa
            map = L.map('map', {
                maxZoom: 19,
                zoomControl: true
            }).setView([-18.47, -70.30], 12);
            
            // Capas de mapa disponibles
            const mapLayers = {
                streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 20
                    
                }),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20
        
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                    
                }),
                terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    maxZoom: 17
                    
                }),
                heat: L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                    maxZoom: 17
                    
                })
            };
            
            // Capa activa (por defecto: streets)
            let currentLayer = mapLayers.streets;
            currentLayer.addTo(map);
            
            // Toggle men√∫ de capas
            $('#mapMenuBtn').click(function(e) {
                e.stopPropagation();
                $('#mapLayersMenu').toggleClass('hidden');
            });
            
            // Cerrar men√∫ al hacer click fuera
            $(document).click(function(e) {
                if (!$(e.target).closest('#mapMenuBtn, #mapLayersMenu').length) {
                    $('#mapLayersMenu').addClass('hidden');
                }
            });
            
            // Cambiar capa de mapa
            $('.map-layer-btn').click(function() {
                const layerType = $(this).data('layer');
                
                // Remover capa actual
                map.removeLayer(currentLayer);
                
                // Agregar nueva capa
                currentLayer = mapLayers[layerType];
                currentLayer.addTo(map);
                
                // Cerrar men√∫
                $('#mapLayersMenu').addClass('hidden');
                
                // Feedback visual
                $('.map-layer-btn').removeClass('bg-blue-100');
                $(this).addClass('bg-blue-100');
            });
            
            map.on('zoomend', function() {
                $('#currentZoom').text(map.getZoom().toFixed(1));
            });
            
            // ============================================
            // B√öSQUEDA DE CALLES CORREGIDA
            // ============================================
            
            $('#streetSearch').on('input', function() {
                const query = $(this).val().trim();
                
                if (query.length > 0) {
                    $('#clearSearch').removeClass('hidden');
                } else {
                    $('#clearSearch').addClass('hidden');
                    $('#searchResults').addClass('hidden').empty();
                    return;
                }
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                searchTimeout = setTimeout(function() {
                    searchStreet(query);
                }, 500);
            });
            
            $('#clearSearch').click(function() {
                $('#streetSearch').val('');
                $('#searchResults').addClass('hidden').empty();
                $(this).addClass('hidden');
                
                if (searchMarker) {
                    map.removeLayer(searchMarker);
                    searchMarker = null;
                }
            });
            
            // Presionar Enter para buscar
            $('#streetSearch').on('keypress', function(e) {
                if (e.which === 13) {
                    const query = $(this).val().trim();
                    if (query) {
                        searchStreet(query);
                    }
                }
            });
            
            // FUNCI√ìN CORREGIDA de b√∫squeda
            function searchStreet(query) {
                $('#searchResults').removeClass('hidden').html('<div class="search-loading"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando en Arica...</div>');
                
                // ‚úÖ CORRECCI√ìN 1: Agregar "Arica" al inicio del query
                const formattedQuery = `Arica, ${query}`;
                
                // ‚úÖ CORRECCI√ìN 2: Usar toBBoxString() y bounded=1
                const url = `https://nominatim.openstreetmap.org/search?` + 
                    `format=json` +
                    `&q=${encodeURIComponent(formattedQuery)}` +
                    `&bounded=1` +  // ‚Üê ESTO ES CLAVE
                    `&viewbox=${ARICA_BOUNDS.toBBoxString()}` +  // ‚Üê FORMATO CORRECTO
                    `&limit=10` +
                    `&addressdetails=1`;
                
                console.log('Buscando:', url); // Para debug
                
                $.ajax({
                    url: url,
                    method: 'GET',
                    headers: {
                        'User-Agent': 'BachesAricaApp/1.0'
                    },
                    success: function(results) {
                        displaySearchResults(results);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error en b√∫squeda:', error);
                        $('#searchResults').html('<div class="search-loading text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error en la b√∫squeda</div>');
                    }
                });
            }
            
            function displaySearchResults(results) {
                if (results.length === 0) {
                    $('#searchResults').html('<div class="search-loading">No se encontraron calles en Arica.<br><small class="text-xs">Intenta: "21 de Mayo", "Baquedano con Col√≥n"</small></div>');
                    return;
                }
                
                // Ordenar por importancia
                results.sort((a, b) => (b.importance || 0) - (a.importance || 0));
                
                let html = '';
                results.forEach(function(result) {
                    const displayName = result.display_name;
                    const address = result.address || {};
                    const streetName = address.road || address.pedestrian || address.footway || displayName.split(',')[0];
                    
                    html += `
                        <div class="search-result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-name="${displayName}">
                            <div class="font-medium text-gray-800">
                                <i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>${streetName}
                            </div>
                            <div class="text-sm text-gray-500 mt-1">${displayName}</div>
                        </div>
                    `;
                });
                
                $('#searchResults').html(html);
                
                $('.search-result-item').click(function() {
                    const lat = parseFloat($(this).data('lat'));
                    const lon = parseFloat($(this).data('lon'));
                    const name = $(this).data('name');
                    
                    map.setView([lat, lon], 18);
                    
                    if (searchMarker) {
                        map.removeLayer(searchMarker);
                    }
                    
                    searchMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'custom-search-marker',
                            html: '<div style="background: #3b82f6; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(map);
                    
                    searchMarker.bindPopup(`
                        <div class="text-center">
                            <strong>${name.split(',')[0]}</strong><br>
                            <small class="text-gray-600">Haz clic en el mapa para reportar un bache</small>
                        </div>
                    `).openPopup();
                    
                    $('#searchResults').addClass('hidden');
                });
            }
            
            // ============================================
            // RESTO DE FUNCIONALIDADES
            // ============================================
            
            // ============================================
            // FUNCIONES DE GOOGLE SHEETS
            // ============================================
            
            // Cargar datos desde Google Sheets
            function loadData() {
                if (isLoadingData) return;
                isLoadingData = true;
                
                console.log('üì• Cargando datos desde Google Sheets...');
                
                $.ajax({
                    url: GOOGLE_SCRIPT_URL + '?action=getAll',
                    method: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        console.log('‚úÖ Respuesta recibida:', response);
                        
                        if (response.success) {
                            potholes = response.data || [];
                            console.log('‚úÖ ' + potholes.length + ' baches cargados');
                            
                            // Generar filtros de a√±os din√°micamente
                            generateYearFilters();
                            
                            // Actualizar contadores de meses
                            updateMonthCounts();
                            
                            // Actualizar display
                            updateDisplay();
                        } else {
                            console.error('‚ùå Error en respuesta:', response.message);
                            alert('Error al cargar datos: ' + response.message);
                        }
                        isLoadingData = false;
                    },
                    error: function(xhr, status, error) {
                        console.error('‚ùå Error AJAX:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        alert('Error de conexi√≥n con Google Sheets. Verifica la URL del script.');
                        isLoadingData = false;
                    }
                });
            }
            
            // Guardar nuevo bache en Google Sheets
            function saveNewPothole(potholeData) {
                console.log('üíæ Guardando bache en Google Sheets...', potholeData);
                
                // Crear objeto de datos
                const payload = {
                    action: 'add',
                    lat: potholeData.lat,
                    lng: potholeData.lng,
                    severity: potholeData.severity,
                    description: potholeData.description
                };
                
                console.log('üì§ Payload:', JSON.stringify(payload));
                
                return $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    method: 'POST',
                    data: JSON.stringify(payload),
                    contentType: 'text/plain', // Cambio importante para CORS
                    dataType: 'json',
                    crossDomain: true,
                    timeout: 15000 // 15 segundos de timeout
                });
            }
            
            // Eliminar bache de Google Sheets
            function deletePotholeFromSheet(id) {
                console.log('üóëÔ∏è Eliminando bache de Google Sheets:', id);
                
                return $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    method: 'POST',
                    data: JSON.stringify({
                        action: 'delete',
                        id: id
                    }),
                    contentType: 'text/plain',
                    dataType: 'json',
                    crossDomain: true,
                    timeout: 15000
                });
            }
            
            // Actualizar estado de bache
            function updatePotholeStatus(id, status) {
                console.log('üìù Actualizando estado del bache:', id, status);
                
                return $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    method: 'POST',
                    data: JSON.stringify({
                        action: 'updateStatus',
                        id: id,
                        status: status
                    }),
                    contentType: 'text/plain',
                    dataType: 'json',
                    crossDomain: true,
                    timeout: 15000
                });
            }
            
            function updateDisplay() {
                if (window.potholeMarkers) {
                    window.potholeMarkers.forEach(m => map.removeLayer(m));
                }
                window.potholeMarkers = [];
                
                // Filtrar seg√∫n estado actual
                let filteredPotholes = potholes;
                if (currentFilter === 'pending') {
                    filteredPotholes = potholes.filter(p => !p.status || p.status === 'Pendiente');
                } else if (currentFilter === 'repaired') {
                    filteredPotholes = potholes.filter(p => p.status === 'Resuelto' || p.status === 'Reparado');
                }
                
                // Filtrar por a√±o
                if (currentYearFilter !== 'all') {
                    filteredPotholes = filteredPotholes.filter(p => {
                        const potholeYear = new Date(p.date).getFullYear();
                        return potholeYear == currentYearFilter;
                    });
                }
                
                // Filtrar por mes
                if (currentMonthFilter !== 'all') {
                    filteredPotholes = filteredPotholes.filter(p => {
                        const potholeMonth = new Date(p.date).getMonth() + 1;
                        return potholeMonth == currentMonthFilter;
                    });
                }
                
                filteredPotholes.forEach(p => {
                    const isRepaired = p.status === 'Resuelto' || p.status === 'Reparado';
                    let iconHtml = '';
                    
                    if (isRepaired) {
                        iconHtml = `<div style="background:#10b981; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; color:white; font-size:12px;">‚úì</div>`;
                    } else {
                        iconHtml = `<div style="background:${severityColors[p.severity]}; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
                    }
                    
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: iconHtml,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const m = L.marker([p.lat, p.lng], { icon: markerIcon }).addTo(map);
                    
                    const statusBadge = isRepaired 
                        ? '<span style="background:#10b981; color:white; padding:2px 8px; border-radius:4px; font-size:11px;">‚úì Reparado</span>'
                        : '<span style="background:#f97316; color:white; padding:2px 8px; border-radius:4px; font-size:11px;">‚è± Pendiente</span>';
                    
                    m.bindPopup(`
                        <div style="text-align:center; min-width:150px;">
                            ${statusBadge}<br><br>
                            <strong>Bache ${p.severity === 'high' ? 'Grave' : p.severity === 'medium' ? 'Moderado' : 'Leve'}</strong><br>
                            <small>${p.description.substring(0, 50)}...</small><br>
                            <button onclick="viewDetail('${p.id}')" style="margin-top:8px; background:#2563eb; color:white; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px;">
                                Ver detalles
                            </button>
                        </div>
                    `);
                    window.potholeMarkers.push(m);
                });
                
                // Actualizar estad√≠sticas
                const pendingCount = potholes.filter(p => !p.status || p.status === 'Pendiente').length;
                const repairedCount = potholes.filter(p => p.status === 'Resuelto' || p.status === 'Reparado').length;
                
                $('#totalCount').text(potholes.length);
                $('#highCount').text(potholes.filter(p => p.severity === 'high').length);
                
                const last24h = new Date(Date.now() - 24 * 60 * 60 * 1000);
                $('#recentCount').text(potholes.filter(p => new Date(p.date) > last24h).length);
                
                // Actualizar contadores de filtros
                $('#countAll').text(potholes.length);
                $('#countPending').text(pendingCount);
                $('#countRepaired').text(repairedCount);
                
                // Actualizar lista
                updatePotholeList();
            }
            
            function updatePotholeList() {
                let filteredPotholes = potholes;
                
                // Filtrar por estado
                if (currentFilter === 'pending') {
                    filteredPotholes = potholes.filter(p => !p.status || p.status === 'Pendiente');
                } else if (currentFilter === 'repaired') {
                    filteredPotholes = potholes.filter(p => p.status === 'Resuelto' || p.status === 'Reparado');
                }
                
                // Filtrar por a√±o
                if (currentYearFilter !== 'all') {
                    filteredPotholes = filteredPotholes.filter(p => {
                        const potholeYear = new Date(p.date).getFullYear();
                        return potholeYear == currentYearFilter;
                    });
                }
                
                // Filtrar por mes
                if (currentMonthFilter !== 'all') {
                    filteredPotholes = filteredPotholes.filter(p => {
                        const potholeMonth = new Date(p.date).getMonth() + 1; // getMonth() retorna 0-11
                        return potholeMonth == currentMonthFilter;
                    });
                }
                
                let listHtml = '';
                if (filteredPotholes.length === 0) {
                    listHtml = '<p class="text-gray-500 text-center py-4 text-sm">No hay baches para los filtros seleccionados</p>';
                } else {
                    filteredPotholes.slice().reverse().forEach(p => {
                        const isRepaired = p.status === 'Resuelto' || p.status === 'Reparado';
                        const statusIcon = isRepaired 
                            ? '<i class="fas fa-check-circle text-green-500"></i>' 
                            : '<i class="fas fa-exclamation-circle text-orange-500"></i>';
                        
                        listHtml += `
                            <div class="border border-gray-200 rounded p-2 hover:bg-gray-50 cursor-pointer text-xs ${isRepaired ? 'opacity-60' : ''}" onclick="viewDetail('${p.id}')">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full flex-shrink-0" style="background:${isRepaired ? '#10b981' : severityColors[p.severity]}"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-800 truncate flex items-center gap-1">
                                            ${statusIcon}
                                            ${p.description.substring(0, 30)}...
                                        </div>
                                        <div class="text-xs text-gray-500">${new Date(p.date).toLocaleDateString()}</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); zoomToPothole('${p.id}', 18)" 
                                        class="bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 text-xs flex-shrink-0">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                $('#potholeList').html(listHtml);
            }
            
            // Funci√≥n para generar din√°micamente los botones de a√±os
            function generateYearFilters() {
                if (potholes.length === 0) {
                    $('#yearFilters').html('<p class="text-gray-500 text-xs text-center py-2">Sin datos</p>');
                    return;
                }
                
                // Extraer todos los a√±os √∫nicos de los datos
                const years = [...new Set(potholes.map(p => new Date(p.date).getFullYear()))];
                years.sort((a, b) => b - a); // Ordenar de m√°s reciente a m√°s antiguo
                
                // Generar HTML de los botones
                let buttonsHtml = `
                    <button class="year-btn bg-purple-500 text-white px-3 py-2 rounded text-xs font-medium hover:bg-purple-600 transition" data-year="all">
                        <i class="fas fa-calendar mr-1"></i>Todos los a√±os (<span class="year-count">${potholes.length}</span>)
                    </button>
                `;
                
                years.forEach(year => {
                    const count = potholes.filter(p => new Date(p.date).getFullYear() === year).length;
                    buttonsHtml += `
                        <button class="year-btn bg-gray-100 hover:bg-purple-100 text-gray-700 hover:text-purple-700 px-3 py-2 rounded text-xs font-medium transition" data-year="${year}">
                            <i class="fas fa-calendar-check mr-1"></i>${year} (<span class="year-count">${count}</span>)
                        </button>
                    `;
                });
                
                $('#yearFilters').html(buttonsHtml);
                
                // Agregar event handlers a los botones de a√±o
                $('.year-btn').click(function() {
                    $('.year-btn').removeClass('bg-purple-500 text-white').addClass('bg-gray-100 text-gray-700');
                    $(this).removeClass('bg-gray-100 text-gray-700').addClass('bg-purple-500 text-white');
                    
                    currentYearFilter = $(this).data('year');
                    
                    // Si cambiamos de a√±o, resetear el filtro de mes
                    currentMonthFilter = 'all';
                    $('.month-btn').removeClass('bg-purple-500 text-white').addClass('bg-gray-100 text-gray-700');
                    $('.month-btn[data-month="all"]').removeClass('bg-gray-100 text-gray-700').addClass('bg-purple-500 text-white');
                    
                    updateMonthCounts();
                    updateDisplay();
                });
            }
            
            // Funci√≥n para actualizar contadores de meses seg√∫n el a√±o seleccionado
            function updateMonthCounts() {
                let yearFilteredPotholes = potholes;
                
                // Filtrar por a√±o si no es "all"
                if (currentYearFilter !== 'all') {
                    yearFilteredPotholes = potholes.filter(p => {
                        return new Date(p.date).getFullYear() == currentYearFilter;
                    });
                }
                
                // Actualizar el contador de "Todos"
                $('.month-btn[data-month="all"]').html(`Todos <span class="text-xs">(${yearFilteredPotholes.length})</span>`);
                
                // Actualizar contadores individuales de cada mes
                for (let month = 1; month <= 12; month++) {
                    const count = yearFilteredPotholes.filter(p => {
                        return new Date(p.date).getMonth() + 1 === month;
                    }).length;
                    
                    const monthBtn = $(`.month-btn[data-month="${month}"]`);
                    const monthNames = ['', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    
                    if (count > 0) {
                        monthBtn.html(`${monthNames[month]} <span class="text-xs">(${count})</span>`);
                        monthBtn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
                    } else {
                        monthBtn.html(`${monthNames[month]} <span class="text-xs">(0)</span>`);
                        monthBtn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
                    }
                }
            }
            
            map.on('click', function(e) {
                selectedLocation = e.latlng;
                $('#lat').val(e.latlng.lat.toFixed(6));
                $('#lng').val(e.latlng.lng.toFixed(6));
                
                if (marker) {
                    map.removeLayer(marker);
                }
                
                marker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background:#3b82f6; width:30px; height:30px; border-radius:50%; border:3px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
            });
            
            $('#reportBtn').click(function() {
                if (!selectedLocation) {
                    alert('Por favor selecciona una ubicaci√≥n en el mapa');
                    return;
                }
                
                const description = $('#description').val().trim();
                if (!description) {
                    alert('Por favor ingresa una descripci√≥n');
                    return;
                }
                
                const newPothole = {
                    lat: selectedLocation.lat,
                    lng: selectedLocation.lng,
                    severity: $('#severity').val(),
                    description: description
                };
                
                console.log('üöÄ Intentando guardar bache:', newPothole);
                
                // Deshabilitar bot√≥n mientras se guarda
                $('#reportBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...');
                
                // Guardar en Google Sheets
                saveNewPothole(newPothole)
                    .done(function(response) {
                        console.log('‚úÖ Respuesta recibida:', response);
                        console.log('Tipo:', typeof response);
                        
                        // A veces viene como string
                        if (typeof response === 'string') {
                            try {
                                response = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parseando:', e);
                            }
                        }
                        
                        if (response && response.success) {
                            alert('¬°Bache reportado exitosamente! ID: ' + (response.id || 'N/A'));
                            
                            // Limpiar formulario
                            $('#description').val('');
                            $('#lat').val('');
                            $('#lng').val('');
                            
                            if (marker) {
                                map.removeLayer(marker);
                                marker = null;
                            }
                            selectedLocation = null;
                            
                            // Recargar datos
                            setTimeout(function() {
                                loadData();
                            }, 1000);
                        } else {
                            alert('Error: ' + (response.message || 'Desconocido'));
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('‚ùå AJAX Error:', {
                            status: status,
                            error: error,
                            responseText: xhr.responseText,
                            statusCode: xhr.status
                        });
                        
                        let msg = 'Error de conexi√≥n.\n\n';
                        
                        if (xhr.status === 0) {
                            msg += '‚ö†Ô∏è POSIBLES CAUSAS:\n\n';
                            msg += '1. El script no est√° implementado como "Aplicaci√≥n web"\n';
                            msg += '2. El permiso no est√° en "Cualquier usuario"\n';
                            msg += '3. Necesitas reimplementar el script\n\n';
                            msg += 'SOLUCI√ìN:\n';
                            msg += '‚Ä¢ Ve a Apps Script\n';
                            msg += '‚Ä¢ Implementar ‚Üí Administrar implementaciones\n';
                            msg += '‚Ä¢ Editar (l√°piz) ‚Üí Nueva versi√≥n\n';
                            msg += '‚Ä¢ Implementar\n\n';
                            msg += 'M√°s detalles en la consola (F12)';
                        } else {
                            msg += 'Error HTTP ' + xhr.status + ': ' + error;
                        }
                        
                        alert(msg);
                    })
                    .always(function() {
                        $('#reportBtn').prop('disabled', false).html('<i class="fas fa-paper-plane mr-2"></i>Reportar');
                    });
            });
            
            $('#clearBtn').click(function() {
                $('#description').val('');
                $('#lat').val('');
                $('#lng').val('');
                
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
                selectedLocation = null;
            });
            
            // Bot√≥n de actualizar/refrescar datos
            $('#refreshBtn').click(function() {
                const $icon = $(this).find('i');
                $icon.addClass('fa-spin');
                
                loadData();
                
                setTimeout(function() {
                    $icon.removeClass('fa-spin');
                }, 1000);
            });
            
            // Filtros de estado
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('bg-blue-500 text-white').addClass('bg-gray-200 text-gray-700');
                $(this).removeClass('bg-gray-200 text-gray-700').addClass('bg-blue-500 text-white');
            });
            
            $('#filterAll').click(function() {
                currentFilter = 'all';
                updateDisplay();
            });
            
            $('#filterPending').click(function() {
                currentFilter = 'pending';
                updateDisplay();
            });
            
            $('#filterRepaired').click(function() {
                currentFilter = 'repaired';
                updateDisplay();
            });
            
            // Event handlers para filtros de mes (delegaci√≥n de eventos para elementos din√°micos)
            $(document).on('click', '.month-btn:not(:disabled)', function() {
                $('.month-btn').removeClass('bg-purple-500 text-white').addClass('bg-gray-100 text-gray-700');
                $(this).removeClass('bg-gray-100 text-gray-700').addClass('bg-purple-500 text-white');
                
                currentMonthFilter = $(this).data('month');
                updateDisplay();
            });
            
            $('#zoomInMax').click(function() {
                const center = map.getCenter();
                map.setView(center, 20);
            });
            
            $('#resetZoom').click(function() {
                map.setView([-18.47, -70.30], 12);
            });
            
            $('.zone-btn').click(function() {
                const lat = parseFloat($(this).data('lat'));
                const lng = parseFloat($(this).data('lng'));
                const zoom = $(this).data('zoom') || 16;
                map.setView([lat, lng], zoom);
            });
            
            window.viewDetail = function(id) {
                const p = potholes.find(p => p.id == id);
                if (!p) {
                    console.error('Bache no encontrado:', id);
                    return;
                }
                
                const isRepaired = p.status === 'Resuelto' || p.status === 'Reparado';
                
                $('#modalContent').html(`
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full" style="background:${isRepaired ? '#10b981' : severityColors[p.severity]}"></div>
                            <div>
                                <h4 class="font-bold text-lg">Bache ${p.severity === 'high' ? 'Grave' : p.severity === 'medium' ? 'Moderado' : 'Leve'}</h4>
                                <p class="text-sm text-gray-600">Reportado: ${new Date(p.date).toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Estado:</h5>
                            <span class="${isRepaired ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-700'} px-3 py-1 rounded-full text-sm font-medium">
                                ${isRepaired ? '‚úì Reparado' : '‚è± Pendiente'}
                            </span>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Descripci√≥n:</h5>
                            <p class="text-gray-600 p-3 bg-gray-50 rounded">${p.description}</p>
                        </div>
                        
                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Ubicaci√≥n:</h5>
                            <p class="text-gray-600">Lat: ${p.lat.toFixed(6)} | Lng: ${p.lng.toFixed(6)}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 pt-4">
                            <button onclick="zoomToPothole('${p.id}', 18)" 
                                class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded transition">
                                <i class="fas fa-search-plus mr-2"></i>Zoom 18x
                            </button>
                            <button onclick="zoomToPothole('${p.id}', 20)" 
                                class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded transition">
                                <i class="fas fa-search mr-2"></i>Zoom 20x
                            </button>
                            ${!isRepaired ? `
                            <button onclick="markAsRepaired('${p.id}')" 
                                class="col-span-2 bg-green-600 hover:bg-green-700 text-white p-3 rounded transition">
                                <i class="fas fa-check mr-2"></i>Marcar como Reparado
                            </button>
                            ` : ''}
                            <button onclick="deletePothole('${p.id}')" 
                                class="col-span-2 bg-red-600 hover:bg-red-700 text-white p-3 rounded transition">
                                <i class="fas fa-trash mr-2"></i>Eliminar
                            </button>
                        </div>
                    </div>
                `);
                
                $('#detailModal').removeClass('hidden').addClass('flex');
            };
            
            // Marcar como reparado
            window.markAsRepaired = function(id) {
                if (confirm('¬øMarcar este bache como reparado?')) {
                    $('#detailModal').find('.bg-gradient-to-r').append('<span id="updateLoading" class="ml-2"><i class="fas fa-spinner fa-spin"></i></span>');
                    
                    updatePotholeStatus(id, 'Reparado')
                        .done(function(response) {
                            console.log('‚úÖ Estado actualizado:', response);
                            
                            if (typeof response === 'string') {
                                try { response = JSON.parse(response); } catch(e) {}
                            }
                            
                            if (response && response.success) {
                                alert('¬°Bache marcado como reparado!');
                                $('#detailModal').removeClass('flex').addClass('hidden');
                                loadData();
                            } else {
                                alert('Error: ' + (response.message || 'Desconocido'));
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('‚ùå Error:', error);
                            alert('Error al actualizar estado');
                        })
                        .always(function() {
                            $('#updateLoading').remove();
                        });
                }
            };
            
            window.zoomToPothole = function(id, zoomLevel = 18) {
                const p = potholes.find(p => p.id == id);
                if (p) {
                    zoomLevel = Math.min(zoomLevel, 20);
                    map.setView([p.lat, p.lng], zoomLevel);
                    $('#detailModal').removeClass('flex').addClass('hidden');
                    
                    const markerIndex = potholes.findIndex(pf => pf.id == id);
                    if (window.potholeMarkers && window.potholeMarkers[markerIndex]) {
                        window.potholeMarkers[markerIndex].openPopup();
                    }
                }
            };
            
            window.deletePothole = function(id) {
                if (confirm('¬øEliminar este reporte de bache?')) {
                    // Mostrar indicador de carga
                    $('#detailModal').find('.bg-gradient-to-r').append('<span id="deleteLoading" class="ml-2"><i class="fas fa-spinner fa-spin"></i></span>');
                    
                    deletePotholeFromSheet(id)
                        .done(function(response) {
                            console.log('‚úÖ Respuesta de eliminaci√≥n:', response);
                            
                            if (response.success) {
                                alert('Bache eliminado exitosamente de Google Sheets');
                                $('#detailModal').removeClass('flex').addClass('hidden');
                                loadData(); // Recargar datos
                            } else {
                                alert('Error al eliminar: ' + response.message);
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('‚ùå Error al eliminar:', error);
                            alert('Error de conexi√≥n al eliminar');
                        })
                        .always(function() {
                            $('#deleteLoading').remove();
                        });
                }
            };
            
            $('#closeModal').click(function() {
                $('#detailModal').removeClass('flex').addClass('hidden');
            });
            
            $(document).click(function(e) {
                if ($(e.target).attr('id') === 'detailModal') {
                    $('#detailModal').removeClass('flex').addClass('hidden');
                }
            });
            
            // Inicializar
            console.log('üöÄ Iniciando aplicaci√≥n Baches Arica');
            console.log('üîó Google Sheets URL:', GOOGLE_SCRIPT_URL);
            
            // Cargar datos desde Google Sheets
            loadData();
            
            $('#currentZoom').text(map.getZoom().toFixed(1));
        });
    </script>
</body>
</html>
